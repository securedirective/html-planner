<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Planner</title>
  <link type="text/css" rel="stylesheet" href="base.css">
</head>
<body>
  <div class="templates">
    <div id="gapPage" class="page gap-page"><div class="page-with-bleed"><div class="page-inside-bleed dot-bg">
    </div></div></div>

    <div id="ifFoundPage" class="page if-found-page"><div class="page-with-bleed"><div class="page-inside-bleed">
      <div>
        This planner belongs to...
        <table class="belongs-to">
          <tbody>
            <tr><td class="header">Name:</td><td class="blank"></td></tr>
            <tr><td class="header">Email:</td><td class="blank"></td></tr>
            <tr><td class="header">Phone:</td><td class="blank"></td></tr>
          </tbody>
        </table>
      </div>
      <div class="vertical-expander"></div>
      <div class="footer">Page {{pageNum}}</div>
    </div></div></div>

    <div id="gridPage" class="page grid-page"><div class="page-with-bleed"><div class="page-inside-bleed dot-bg">
      <div class="page-header">{{month.shortName}}</div>
      <div class="vertical-expander"></div>
      <div class="footer">Page {{pageNum}}</div>
    </div></div></div>

    <div id="habitsPage" class="page habits-page"><div class="page-with-bleed"><div class="page-inside-bleed dot-bg">
      <div class="page-header">Notes</div>
      <div>
      <div class="wrapper">
        <table class="habits-table">
          <thead>
            <tr><th><div class="title">Habit Tracker</div></th><!-- The remaining headers are added here via javascript --></tr>
          </thead>
          <tbody>
            <!-- The remaining rows are added here via javascript -->
          </tbody>
        </table>
      </div>
      </div>
      <div class="vertical-expander"></div>
      <div class="footer">Page {{pageNum}}</div>
    </div></div></div>

    <div id="monthSpreadA" class="page month-spread"><div class="page-with-bleed"><div class="page-inside-bleed dot-bg">
      <div class="page-header">{{month.title}}</div>
      <div>
        <table class="month-table">
          <thead>
            <tr>
              <th>Mon</th>
              <th>Tue</th>
              <th>Wed</th>
            </tr>
          </thead>
          <tbody>
            <!-- The remaining rows are added here via javascript -->
          </tbody>
        </table>
      </div>
      <div class="vertical-expander"></div>
      <div class="footer">Page {{pageNum}}</div>
    </div></div></div>

    <div id="monthSpreadB" class="page month-spread"><div class="page-with-bleed"><div class="page-inside-bleed dot-bg">
      <div class="page-header"></div>
      <div>
        <table class="month-table">
          <thead>
            <tr>
              <th>Thu</th>
              <th>Fri</th>
              <th>Sat/Sun</th>
            </tr>
          </thead>
          <tbody>
            <!-- The remaining rows are added here via javascript -->
          </tbody>
        </table>
      </div>
      <div class="vertical-expander"></div>
      <div class="footer">Page {{pageNum}}</div>
    </div></div></div>

    <div id="weekSpreadA" class="page week-spread"><div class="page-with-bleed"><div class="page-inside-bleed dot-bg">
      <div class="page-header">{{month.shortName}}</div>
      <table class="week-table">
        <tbody>
          <tr>
            <td>
              <div class="cell-header">
                <span class="day-num">{{week.dates[0].getDate()}}</span>
                <span class="day-of-week">Mon</span>
                <div class="who-is-where">K</div><div class="who-is-where">A</div><div class="who-is-where">C</div><div class="who-is-where">I</div>
              </div>
              <div class="cell-content">
                <div class="personal-col">Personal</div>
                <div class="vertical-sep"></div>
                <div class="work-col">Work</div>
              </div>
            </td>
          </tr>
          <tr>
            <td>
              <div class="cell-header">
                <span class="day-num">{{week.dates[1].getDate()}}</span>
                <span class="day-of-week">Tue</span>
                <div class="who-is-where">K</div><div class="who-is-where">A</div><div class="who-is-where">C</div><div class="who-is-where">I</div>
              </div>
              <div class="cell-content">
                <div class="personal-col">Personal</div>
                <div class="vertical-sep"></div>
                <div class="work-col">Work</div>
              </div>
            </td>
          </tr>
          <tr>
            <td>
              <div class="cell-header">
                <span class="day-num">{{week.dates[2].getDate()}}</span>
                <span class="day-of-week">Wed</span>
                <div class="who-is-where">K</div><div class="who-is-where">A</div><div class="who-is-where">C</div><div class="who-is-where">I</div>
              </div>
              <div class="cell-content">
                <div class="personal-col">Personal</div>
                <div class="vertical-sep"></div>
                <div class="work-col">Work</div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
      <div class="vertical-expander"></div>
      <div class="footer">Page {{pageNum}}</div>
    </div></div></div>

    <div id="weekSpreadB" class="page week-spread"><div class="page-with-bleed"><div class="page-inside-bleed dot-bg">
      <div class="page-header">Week {{week.num}}</div>
      <table class="week-table">
        <tbody>
          <tr>
            <td>
              <div class="cell-header">
                <span class="day-num">{{week.dates[3].getDate()}}</span>
                <span class="day-of-week">Thu</span>
                <div class="who-is-where">K</div><div class="who-is-where">A</div><div class="who-is-where">C</div><div class="who-is-where">I</div>
              </div>
              <div class="cell-content">
                <div class="personal-col">Personal</div>
                <div class="vertical-sep"></div>
                <div class="work-col">Work</div>
              </div>
            </td>
          </tr>
          <tr>
            <td>
              <div class="cell-header">
                <span class="day-num">{{week.dates[4].getDate()}}</span>
                <span class="day-of-week">Fri</span>
                <div class="who-is-where">K</div><div class="who-is-where">A</div><div class="who-is-where">C</div><div class="who-is-where">I</div>
              </div>
              <div class="cell-content">
                <div class="personal-col">Personal</div>
                <div class="vertical-sep"></div>
                <div class="work-col">Work</div>
              </div>
            </td>
          </tr>
          <tr class="weekend">
            <td>
              <div class="cell-header">
                <span class="day-num">{{week.dates[5].getDate()}}</span>
                <span class="day-of-week">Sat</span>
                <div class="who-is-where">K</div><div class="who-is-where">A</div><div class="who-is-where">C</div><div class="who-is-where">I</div>
              </div>
            </td>
          </tr>
          <tr class="weekend">
            <td>
              <div class="cell-header">
                <span class="day-num">{{week.dates[6].getDate()}}</span>
                <span class="day-of-week">Sun</span>
                <div class="who-is-where">K</div><div class="who-is-where">A</div><div class="who-is-where">C</div><div class="who-is-where">I</div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
      <div class="vertical-expander"></div>
      <div class="footer">Page {{pageNum}}</div>
    </div></div></div>

    <div id="indexPage" class="page index-page"><div class="page-with-bleed"><div class="page-inside-bleed dot-bg">
      <div class="vertical-expander"></div>
      <div class="footer">Page {{pageNum}}</div>
    </div></div></div>
  </div>

  <div id="pageContainer" class="page-container"></div>

  <script>
  const MON = 1;
  const TUE = 2;
  const WED = 3;
  const THU = 4;
  const FRI = 5;
  const SAT = 6;
  const SUN = 7;
  const MONTH_NAMES = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
  const MONTH_NAMES_ABBREV = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

  var pageContainer = document.getElementById('pageContainer');
  var pageNum = 1
  var monthSpreads = [];

  function formatDate(date) {
    return `${date.getMonth()+1}/${date.getDate()}`;
  }

  function getDayOfWeek(date) {
    // Returns Mon=1, Tue=2, ... Sat=6, Sun=7 (this differs from default
    // Javascript that uses Sun=0, Mon=1, ...)
    var dayOfWeek = date.getDay();
    if (dayOfWeek < 1) dayOfWeek += 7;
    return dayOfWeek;
  }

  function offsetDays(date, days) {
    // Returns a new date shifted by the number of days provided; original date
    // is not changed
    var newDate = new Date(date);
    newDate.setDate(newDate.getDate() + days);
    return newDate;
  }

  function shiftBackToMonday(date) {
    // Returns the date if it's Monday, else shifted back to the nearest Monday
    var dayOfWeek = getDayOfWeek(date);
    return dayOfWeek == MON ? new Date(date) : offsetDays(date, MON - dayOfWeek);
  }

  function shiftForwardToSunday(date) {
    // Returns the date if it's Sunday, else shifted forward to the nearest Sunday
    var dayOfWeek = getDayOfWeek(date);
    return dayOfWeek == SUN ? new Date(date) : offsetDays(date, SUN - dayOfWeek);
  }

  // function isDate(v) {
  //   return (!!v && typeof v.getMonth === 'function');
  // }

  function getDateRange(start, end) {
    var dates = [];
    var offset = 0;
    // console.log(start, end);
    // if (!(isDate(start) && isDate(start))) throw new Error('abc');
    while (true) {
      var date = offsetDays(start, offset);
      // console.log(date);
      if (date > end) break;
      dates.push(date);
      offset++;
      // Fail safe
      if (offset > 1000) throw new Error('Too many iterations');
    }
    return dates;
  }

  function processPlaceholders(elem) {
    // Process placeholders here
    if (elem.nodeType == Node.TEXT_NODE) {
      var oldContent = elem.textContent;
      var newContent = oldContent.replaceAll(/\{\{([^{}]+)\}\}/g, function(_, inner) {
        try {
          var ret = eval(inner);
          if (ret === undefined) {
            console.warn(`Undefined variable: ${inner}`);
            return 'UNDEFINED'
          } else {
            return ret;
          }
        } catch (e) {
          console.error(e);
          return 'ERROR';
        }
      })
      if (newContent != oldContent) {
        elem.textContent = newContent;
      }
    }
    for (var node of elem.childNodes) {
      processPlaceholders(node);
    }
  }

  function cloneWithContext(templateId) {
    var templateElem = document.getElementById(templateId);
    var newElem = templateElem.cloneNode(true);
    newElem.removeAttribute('id');
    processPlaceholders(newElem);
    return newElem;
  }

  function addPage(page) {
    pageNum++;
    pageContainer.appendChild(page);
  }

  function addGap() {
    pageContainer.appendChild(cloneWithContext('gapPage'));
  }

  function createMonthAndWeekSpreads(startingYearNum, monthCount) {
    // Create months, including the extra ones past the end of the year
    for (var x=0; x<monthCount; x++) {
      var yearNum = startingYearNum + Math.trunc(x / 12);
      var monthNum = x % 12;
      var firstDate = new Date(yearNum, monthNum, 1);
      var lastDate = new Date(yearNum, monthNum+1, 0);
      var month = {
        num: monthNum,
        title: `${MONTH_NAMES[monthNum]} ${yearNum}`,
        name: `${MONTH_NAMES[monthNum]}`,
        shortName: `${MONTH_NAMES_ABBREV[monthNum]}`,
        firstDate: firstDate,
        lastDate: lastDate,
        numDays: new Date(yearNum, monthNum + 1, 0).getDate(),
        firstDisplayedDate: shiftBackToMonday(firstDate),
        lastDisplayedDate: shiftForwardToSunday(lastDate),
        weekRowsOnOverview: [],
        weekSpreads: x<12 ? [] : null,
      };
      monthSpreads.push(month);
    }

    // Calculate all weeks that overlap the total date range
    var weeks = [];
    var firstDate = monthSpreads[0].firstDisplayedDate;
    var weekNum = 1;
    while (true) {
      var lastDate = offsetDays(firstDate, 6);
      var firstDateMonth = firstDate.getMonth();
      var lastDateMonth = lastDate.getMonth();
      week = {
        num: weekNum,
        firstDate: firstDate,
        lastDate: lastDate,
        dates: getDateRange(firstDate, lastDate),
      };
      weeks.push(week);
      // Prep for next iteration
      weekNum++;
      firstDate = offsetDays(firstDate, 7);
      if (firstDate > monthSpreads[monthSpreads.length-1].lastDisplayedDate) break;
    }

    // Create week records and link them to the appropriate months, without any duplicates
    var insertIntoMonth1 = 0;
    for (var week of weeks) {
      if (week.firstDate > monthSpreads[insertIntoMonth1].lastDisplayedDate) insertIntoMonth1++;
      if (monthSpreads[insertIntoMonth1] && monthSpreads[insertIntoMonth1].weekSpreads!==null) {
        monthSpreads[insertIntoMonth1].weekSpreads.push(week);
      }
    }

    // Now add those same week records to the months while allowing duplicates,
    // for the purpose of rendering the month spreads
    var insertIntoMonth2 = 0;
    for (var week of weeks) {
      if (week.firstDate > monthSpreads[insertIntoMonth2].lastDate) {
        insertIntoMonth2++;
        if (insertIntoMonth2 >= monthCount) break;
      }
      monthSpreads[insertIntoMonth2].weekRowsOnOverview.push(week);
      if (week.lastDate > monthSpreads[insertIntoMonth2].lastDate) {
        insertIntoMonth2++;
        if (insertIntoMonth2 >= monthCount) break;
        monthSpreads[insertIntoMonth2].weekRowsOnOverview.push(week);
      }
    }
  }

  createMonthAndWeekSpreads(2024, 18);

  // Debug stuff
  // for (var key of ['weekRowsOnOverview', 'weekSpreads']) {
  //   console.log(key);
  //   var lastWeekNum = 0;
  //   for (var month of months) {
  //     for (var week of month[key]) {
  //       var ast;
  //       if (week.num == (lastWeekNum+1)) {
  //         ast = 'Next';
  //       } else if (week.num == lastWeekNum) {
  //         ast = 'DUPLICATE';
  //       } else {
  //         throw new Error(`Unexpected shift: ${lastWeekNum} -> ${week.num}`);
  //       }
  //       console.log(`Month: ${formatDate(month.firstDate)} to ${formatDate(month.lastDate)}                Week ${week.num} (${ast}): ${formatDate(week.firstDate)} to ${formatDate(week.lastDate)}`);
  //       lastWeekNum = week.num;
  //     }
  //   }
  // }

  // Generate the final output from templates
  addGap();
  addPage(cloneWithContext('ifFoundPage'));
  for (var month of monthSpreads) {
    var page, table, tbody, tr, th, td;
    for (var sideA of [true, false]) {
      page = cloneWithContext(sideA ? 'monthSpreadA' : 'monthSpreadB');
      table = page.getElementsByTagName('table')[0];
      tbody = table.getElementsByTagName('tbody')[0];
      for (var week of month.weekRowsOnOverview) {
        tr1 = document.createElement('tr');
        tr2 = document.createElement('tr');
        if (month.weekRowsOnOverview.length > 5) {
          tr1.classList.add('smaller');
          tr2.classList.add('smaller');
        }
        for (var x = (sideA ? MON : THU); x <= (sideA ? WED : SUN); x++) {
          var date = week.dates[x-1];
          td = document.createElement('td');
          td.rowSpan = (x == SAT || x == SUN) ? '1' : '2';
          if (date.getMonth() != month.num) td.classList.add('extra-day');
          td.innerHTML = `<span class="day-num">${date.getDate()}</span>`
          trToUse = x == SUN ? tr2 : tr1;
          trToUse.appendChild(td);
        }
        tbody.appendChild(tr1);
        tbody.appendChild(tr2);
      }
      addPage(page);
    }
    if (month.weekSpreads!==null) {
      addPage(cloneWithContext('gridPage'));

      page = cloneWithContext('habitsPage');
      table = page.getElementsByTagName('table')[0];
      tbody = table.getElementsByTagName('tbody')[0];
      var theadTr = table.getElementsByTagName('thead')[0].children[0];
      var habitCount = 4;
      for (var y=0; y<habitCount; y++) {
        theadTr.appendChild(document.createElement('td'));
      }
      for (var x=0; x<month.numDays; x++) {
        tr = document.createElement('tr');
        th = document.createElement('th');
        th.innerHTML = x+1;
        tr.appendChild(th);
        for (var y=0; y<habitCount; y++) {
          tr.appendChild(document.createElement('td'));
        }
        tbody.appendChild(tr);
      }
      addPage(page);

      for (var week of month.weekSpreads) {
        addPage(cloneWithContext('weekSpreadA'));
        addPage(cloneWithContext('weekSpreadB'));
      }
    }
  }
  addPage(cloneWithContext('indexPage'));
  addGap();
  </script>
</body>
</html>
