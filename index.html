<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>title</title>
  <link type="text/css" rel="stylesheet" href="base.css">
</head>
<body>
  <div class="templates">
    <div id="monthSpreadA" class="page month-spread"><div class="page-with-bleed"><div class="page-inside-bleed">
      <div class="header">
        {{month.name}} {{month.year}}
      </div>
      <div>
        <table>
          <tr class="header-row">
            <th class="day-col">Mon</th>
            <th class="day-col">Tue</th>
            <th class="day-col">Wed</th>
          </tr>
          <tr class="day-row">
            <td class="day-cell dot-bg{{month.dates[0].getMonth() == month.num ? ' extra-day' : ''}}" rowspan="2"><span class="day-num">{{month.dates[0].getDate()}}</span></td>
            <td class="day-cell dot-bg{{month.dates[1].getMonth() == month.num ? ' extra-day' : ''}}" rowspan="2"><span class="day-num">{{month.dates[1].getDate()}}</span></td>
            <td class="day-cell dot-bg{{month.dates[2].getMonth() == month.num ? ' extra-day' : ''}}" rowspan="2"><span class="day-num">{{month.dates[2].getDate()}}</span></td>
          </tr>
          <tr class="day-row">
          </tr>
          <tr class="day-row">
            <td class="day-cell dot-bg{{month.dates[7].getMonth() == month.num ? ' extra-day' : ''}}" rowspan="2"><span class="day-num">{{month.dates[7].getDate()}}</span></td>
            <td class="day-cell dot-bg{{month.dates[8].getMonth() == month.num ? ' extra-day' : ''}}" rowspan="2"><span class="day-num">{{month.dates[8].getDate()}}</span></td>
            <td class="day-cell dot-bg{{month.dates[9].getMonth() == month.num ? ' extra-day' : ''}}" rowspan="2"><span class="day-num">{{month.dates[9].getDate()}}</span></td>
          </tr>
          <tr class="day-row">
          </tr>
          <tr class="day-row">
            <td class="day-cell dot-bg{{month.dates[14].getMonth() == month.num ? ' extra-day' : ''}}" rowspan="2"><span class="day-num">{{month.dates[14].getDate()}}</span></td>
            <td class="day-cell dot-bg{{month.dates[15].getMonth() == month.num ? ' extra-day' : ''}}" rowspan="2"><span class="day-num">{{month.dates[15].getDate()}}</span></td>
            <td class="day-cell dot-bg{{month.dates[16].getMonth() == month.num ? ' extra-day' : ''}}" rowspan="2"><span class="day-num">{{month.dates[16].getDate()}}</span></td>
          </tr>
          <tr class="day-row">
          </tr>
          <tr class="day-row">
            <td class="day-cell dot-bg{{month.dates[21].getMonth() == month.num ? ' extra-day' : ''}}" rowspan="2"><span class="day-num">{{month.dates[21].getDate()}}</span></td>
            <td class="day-cell dot-bg{{month.dates[22].getMonth() == month.num ? ' extra-day' : ''}}" rowspan="2"><span class="day-num">{{month.dates[22].getDate()}}</span></td>
            <td class="day-cell dot-bg{{month.dates[23].getMonth() == month.num ? ' extra-day' : ''}}" rowspan="2"><span class="day-num">{{month.dates[23].getDate()}}</span></td>
          </tr>
          <tr class="day-row">
          </tr>
          <tr class="day-row">
            <td class="day-cell dot-bg{{month.dates[28].getMonth() == month.num ? ' extra-day' : ''}}" rowspan="2"><span class="day-num">{{month.dates[28].getDate()}}</span></td>
            <td class="day-cell dot-bg{{month.dates[29].getMonth() == month.num ? ' extra-day' : ''}}" rowspan="2"><span class="day-num">{{month.dates[29].getDate()}}</span></td>
            <td class="day-cell dot-bg{{month.dates[30].getMonth() == month.num ? ' extra-day' : ''}}" rowspan="2"><span class="day-num">{{month.dates[30].getDate()}}</span></td>
          </tr>
          <tr class="day-row">
          </tr>
        </table>
      </div>
      <div class="vertical-expander dot-bg"></div>
      <div class="footer">Page {{pageNum}}</div>
    </div></div></div>
    <tr id="monthRowA" class="day-row">
      <td class="day-cell dot-bg{{month.dates[0].getMonth() == month.num ? ' extra-day' : ''}}" rowspan="2"><span class="day-num">{{month.dates[0].getDate()}}</span></td>
      <td class="day-cell dot-bg{{month.dates[1].getMonth() == month.num ? ' extra-day' : ''}}" rowspan="2"><span class="day-num">{{month.dates[1].getDate()}}</span></td>
      <td class="day-cell dot-bg{{month.dates[2].getMonth() == month.num ? ' extra-day' : ''}}" rowspan="2"><span class="day-num">{{month.dates[2].getDate()}}</span></td>
    </tr>
    <div id="monthSpreadB" class="page month-spread"><div class="page-with-bleed"><div class="page-inside-bleed">
      <div class="header">

      </div>
      <div>
        <table>
          <tr class="header-row">
            <th class="day-col">Thu</th>
            <th class="day-col">Fri</th>
            <th class="day-col">Sat/Sun</th>
          </tr>
          <tr class="day-row">
            <td class="day-cell dot-bg{{month.dates[3].getMonth() == month.num ? ' extra-day' : ''}}" rowspan="2"><span class="day-num">{{month.dates[3].getDate()}}</span></td>
            <td class="day-cell dot-bg{{month.dates[4].getMonth() == month.num ? ' extra-day' : ''}}" rowspan="2"><span class="day-num">{{month.dates[4].getDate()}}</span></td>
            <td class="day-cell dot-bg{{month.dates[5].getMonth() == month.num ? ' extra-day' : ''}}" rowspan="1"><span class="day-num">{{month.dates[5].getDate()}}</span></td>
          </tr>
          <tr class="day-row">
            <td class="day-cell dot-bg{{month.dates[6].getMonth() == month.num ? ' extra-day' : ''}}" rowspan="1"><span class="day-num">{{month.dates[6].getDate()}}</span></td>
          </tr>
          <tr class="day-row">
            <td class="day-cell dot-bg{{month.dates[10].getMonth() == month.num ? ' extra-day' : ''}}" rowspan="2"><span class="day-num">{{month.dates[10].getDate()}}</span></td>
            <td class="day-cell dot-bg{{month.dates[11].getMonth() == month.num ? ' extra-day' : ''}}" rowspan="2"><span class="day-num">{{month.dates[11].getDate()}}</span></td>
            <td class="day-cell dot-bg{{month.dates[12].getMonth() == month.num ? ' extra-day' : ''}}" rowspan="1"><span class="day-num">{{month.dates[12].getDate()}}</span></td>
          </tr>
          <tr class="day-row">
            <td class="day-cell dot-bg{{month.dates[13].getMonth() == month.num ? ' extra-day' : ''}}" rowspan="1"><span class="day-num">{{month.dates[13].getDate()}}</span></td>
          </tr>
          <tr class="day-row">
            <td class="day-cell dot-bg{{month.dates[17].getMonth() == month.num ? ' extra-day' : ''}}" rowspan="2"><span class="day-num">{{month.dates[17].getDate()}}</span></td>
            <td class="day-cell dot-bg{{month.dates[18].getMonth() == month.num ? ' extra-day' : ''}}" rowspan="2"><span class="day-num">{{month.dates[18].getDate()}}</span></td>
            <td class="day-cell dot-bg{{month.dates[19].getMonth() == month.num ? ' extra-day' : ''}}" rowspan="1"><span class="day-num">{{month.dates[19].getDate()}}</span></td>
          </tr>
          <tr class="day-row">
            <td class="day-cell dot-bg{{month.dates[20].getMonth() == month.num ? ' extra-day' : ''}}" rowspan="1"><span class="day-num">{{month.dates[20].getDate()}}</span></td>
          </tr>
          <tr class="day-row">
            <td class="day-cell dot-bg{{month.dates[24].getMonth() == month.num ? ' extra-day' : ''}}" rowspan="2"><span class="day-num">{{month.dates[24].getDate()}}</span></td>
            <td class="day-cell dot-bg{{month.dates[25].getMonth() == month.num ? ' extra-day' : ''}}" rowspan="2"><span class="day-num">{{month.dates[25].getDate()}}</span></td>
            <td class="day-cell dot-bg{{month.dates[26].getMonth() == month.num ? ' extra-day' : ''}}" rowspan="1"><span class="day-num">{{month.dates[26].getDate()}}</span></td>
          </tr>
          <tr class="day-row">
            <td class="day-cell dot-bg{{month.dates[27].getMonth() == month.num ? ' extra-day' : ''}}" rowspan="1"><span class="day-num">{{month.dates[27].getDate()}}</span></td>
          </tr>
          <tr class="day-row">
            <td class="day-cell dot-bg{{month.dates[31].getMonth() == month.num ? ' extra-day' : ''}}" rowspan="2"><span class="day-num">{{month.dates[31].getDate()}}</span></td>
            <td class="day-cell dot-bg{{month.dates[32].getMonth() == month.num ? ' extra-day' : ''}}" rowspan="2"><span class="day-num">{{month.dates[32].getDate()}}</span></td>
            <td class="day-cell dot-bg{{month.dates[33].getMonth() == month.num ? ' extra-day' : ''}}" rowspan="1"><span class="day-num">{{month.dates[33].getDate()}}</span></td>
          </tr>
          <tr class="day-row">
            <td class="day-cell dot-bg{{month.dates[34].getMonth() == month.num ? ' extra-day' : ''}}" rowspan="1"><span class="day-num">{{month.dates[34].getDate()}}</span></td>
          </tr>
        </table>
      </div>
      <div class="vertical-expander dot-bg"></div>
      <div class="footer">Page {{pageNum}}</div>
    </div></div></div>
    <div id="weekSpreadA" class="page week-spread"><div class="page-with-bleed"><div class="page-inside-bleed">
      <div class="header">
        {{month.name}} {{month.year}}
      </div>
      <table>
        <tr class="day-row">
          <td class="day-cell dot-bg">
            <div class="cell-header">
              <span class="day-num">1</span>
              <span class="day-of-week">Mon</span>
            </div>
            <div class="cell-content">
              <div class="personal-col">Personal</div>
              <div class="vertical-sep"></div>
              <div class="work-col">Work</div>
            </div>
          </td>
          <td class="goals-cell dot-bg" rowspan="3">
            <div class="cell-header">Week goals</div>
          </td>
        </tr>
        <tr class="day-row">
          <td class="day-cell dot-bg">
            <div class="cell-header">
              <span class="day-num">2</span>
              <span class="day-of-week">Tue</span>
            </div>
            <div class="cell-content">
              <div class="personal-col">Personal</div>
              <div class="vertical-sep"></div>
              <div class="work-col">Work</div>
            </div>
          </td>
        </tr>
        <tr class="day-row">
          <td class="day-cell dot-bg">
            <div class="cell-header">
              <span class="day-num">31</span>
              <span class="day-of-week">Wed</span>
            </div>
            <div class="cell-content">
              <div class="personal-col">Personal</div>
              <div class="vertical-sep"></div>
              <div class="work-col">Work</div>
            </div>
          </td>
        </tr>
      </table>
      <div class="vertical-expander dot-bg"></div>
      <div class="footer">Page {{pageNum}}</div>
    </div></div></div>
    <div id="weekSpreadB" class="page week-spread"><div class="page-with-bleed"><div class="page-inside-bleed">
      <div class="header">
        Week {{week.num}}
      </div>
      <table>
        <tr class="day-row">
          <td class="blockers-cell dot-bg">
            <div class="cell-header">Blockers</div>
          </td>
          <td class="day-cell dot-bg">
            <div class="cell-header">
              <span class="day-num">4</span>
              <span class="day-of-week">Thu</span>
            </div>
            <div class="cell-content">
              <div class="personal-col">Personal</div>
              <div class="vertical-sep"></div>
              <div class="work-col">Work</div>
            </div>
          </td>
        </tr>
        <tr class="day-row">
          <td class="moments-cell dot-bg" rowspan="3">
            <div class="cell-header">Moments</div>
          </td>
          <td class="day-cell dot-bg">
            <div class="cell-header">
              <span class="day-num">5</span>
              <span class="day-of-week">Fri</span>
            </div>
            <div class="cell-content">
              <div class="personal-col">Personal</div>
              <div class="vertical-sep"></div>
              <div class="work-col">Work</div>
            </div>
          </td>
        </tr>
        <tr class="day-row half-height">
          <td class="day-cell dot-bg">
            <div class="cell-header">
              <span class="day-num">6</span>
              <span class="day-of-week">Sat</span>
            </div>
          </td>
        </tr>
        <tr class="day-row half-height">
          <td class="day-cell dot-bg">
            <div class="cell-header">
              <span class="day-num">7</span>
              <span class="day-of-week">Sun</span>
            </div>
          </td>
        </tr>
      </table>
      <div class="vertical-expander dot-bg"></div>
      <div class="footer">Page {{pageNum}}</div>
    </div></div></div>
  </div>

  <div id="pageContainer" class="page-container"></div>

  <script>
  var pageContainer = document.getElementById('pageContainer');
  var pageNum = 1;
  const MONDAY = 1;
  const SUNDAY = 7;

  function getDayOfWeek(dt) {
    // Returns Mon=1, Tue=2, ... Sat=6, Sun=7 (this differs from default
    // Javascript that uses Sun=0, Mon=1, ...)
    var dayOfWeek = dt.getDay();
    if (dayOfWeek < 1) dayOfWeek += 7;
    return dayOfWeek;
  }

  function offsetDays(date, days) {
    // Returns a new date shifted by the number of days provided; original date
    // is not changed
    var newDate = new Date(date);
    newDate.setDate(newDate.getDate() + days);
    return newDate;
  }

  function shiftBackToMonday(date) {
    // Returns the date if it's Monday, else shifted back to the nearest Monday
    var dayOfWeek = getDayOfWeek(date);
    return dayOfWeek == MONDAY ? new Date(date) : offsetDays(date, MONDAY - dayOfWeek);
  }

  function shiftForwardToSunday(date) {
    // Returns the date if it's Sunday, else shifted forward to the nearest Sunday
    var dayOfWeek = getDayOfWeek(date);
    return dayOfWeek == SUNDAY ? new Date(date) : offsetDays(date, SUNDAY - dayOfWeek);
  }

  function getDateRange(start, end) {
    var dates = [];
    var offset = 0;
    while (true) {
      var date = offsetDays(start, offset);
      if (date > end) break;
      dates.push(date);
      offset++;
    }
    return dates;
  }

  function processPlaceholders(elem) {
    // Process placeholders here
    if (elem.nodeType == Node.TEXT_NODE) {
      var oldContent = elem.textContent;
      var newContent = oldContent.replaceAll(/\{\{([^{}]+)\}\}/g, function(_, inner) {
        try {
          var ret = eval(inner);
          if (ret === undefined) {
            console.warn(`Undefined variable: ${inner}`);
            return 'UNDEFINED'
          } else {
            return ret;
          }
        } catch (e) {
          console.error(e);
          return 'ERROR';
        }
      })
      if (newContent != oldContent) {
        elem.textContent = newContent;
      }
    }
    for (var node of elem.childNodes) {
      processPlaceholders(node);
    }
  }

  function cloneWithContext(templateElem) {
    var newElem = templateElem.cloneNode(true);
    processPlaceholders(newElem);
    return newElem;
  }

  function addPage(page) {
    pageContainer.appendChild(page);
    pageNum++;
  }

  var yearNum = 2010;
  var monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
  var months = [];

  for (var monthNum=1; monthNum<=12; monthNum++) {
    firstDay = new Date(yearNum, monthNum-1, 1);
    lastDay = offsetDays(new Date(yearNum, monthNum, 1), -1);
    var month = {
      num: monthNum,
      year: yearNum,
      name: monthNames[monthNum-1],
      startDate: shiftBackToMonday(firstDay),
      endDate: shiftForwardToSunday(lastDay),
      weeks: [],
    };
    month.dates = getDateRange(month.startDate, month.endDate);
    months.push(month);
  }

  var weeks = [];
  var startOfWeek = months[0].startDate;
  var weekNum = 1;
  var insertIntoMonth = 0;
  while (true) {
    week = {
      num: weekNum,
      startDate: startOfWeek,
      endDate: offsetDays(startOfWeek, 6),
      days: [],
    };
    week.dates = getDateRange(week.startDate, week.endDate);
    weeks.push(week);
    if (months[insertIntoMonth]) {
      if (week.startDate > months[insertIntoMonth].endDate) insertIntoMonth++;
      if (months[insertIntoMonth]) {
        months[insertIntoMonth].weeks.push(week);
      }
    }
    // Prep for next iteration
    weekNum++;
    startOfWeek = offsetDays(startOfWeek, 7);
    if (startOfWeek > months[11].endDate) break;
  }

  // console.log(months);
  // console.log(weeks);

  for (var month of months) {
    addPage(cloneWithContext(document.getElementById('monthSpreadA')));
    addPage(cloneWithContext(document.getElementById('monthSpreadB')));

    // for (var week of month.weeks) {
    //   addPage(cloneWithContext(document.getElementById('weekSpreadA')));
    //   addPage(cloneWithContext(document.getElementById('weekSpreadB')));
    // }
  }
  </script>
</body>
</html>
